<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'bootstrap-3.3.7-dist/css/bootstrap.css' %}">
    <style>
        th {
            text-align: center;
        }

        .panel-heading a {
            float: right;
        }

        table {
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-8 col-lg-offset-2">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">个人中心
                        <a href="{% url 'app01:logout' %}">注销</a>
                    </h3>

                </div>
                <div class="panel-body">
                    <table class="table table-hover text-center">
                        <thead>
                        <tr>
                            <th>用户名</th>
                            <th>爱好</th>
                            <th>电话号码</th>
                            <th>邮箱</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="text-center">
                            <td>{{ request.user.username }}</td>
                            <td>
                                {% for i in hobby_obj %}
                                    {% for j in hobby_list %}
                                        {% if i.id == j %}
                                            {{ i.name }}|
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </td>
                            <td>{{ request.user.phone }}</td>
                            <td>{{ request.user.email }}</td>
                            <td>
                                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#Mymodel">
                                    修改密码
                                </button>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="Mymodel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="gridSystemModalLabel">修改密码</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 col-md-offset-3">
                        <form>
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="password">原密码</label>
                                <input type="text" class="form-control" id="password" placeholder="原密码">
                                <span style="color: red;"></span>
                            </div>
                            <div class="form-group">
                                <label for="new_password">新密码</label>
                                <input type="password" class="form-control" id="new_password" placeholder="新密码">
                                <span style="color: red;"></span>
                            </div>
                            <div class="form-group">
                                <label for="re_password">新密码</label>
                                <input type="password" class="form-control" id="re_password" placeholder="确认密码">
                                <span style="color: red;"></span>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="close_model">关闭</button>
                <button type="button" class="btn btn-primary" id="ajax_submit">提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script src="{% static 'jquery.js' %}"></script>
<script src="{% static 'bootstrap-3.3.7-dist/js/bootstrap.js' %}"></script>
<script>
    //给模态框中的提交按钮绑定ajax提交
    $("#ajax_submit").click(function () {
        $.ajax({
            url: "{% url 'app01:set_pwd' %}",
            type: "POST",
            data: {
                "old_pwd": $("#password").val(),
                "new_pwd": $("#new_password").val(),
                "re_new_pwd": $("#re_password").val(),
                "csrfmiddlewaretoken": $("[name='csrfmiddlewaretoken']").val(),
            },
            success: function (ret) {
                if (ret.status === 1){
                    //修改成功跳转到登录页面
                    location.href = "{% url 'app01:my_login' %}"
                }else{
                    //修改失败后显示错误
                    var $id = ret.status;
                    $("#"+ $id).next().text(ret.err_msg);
                }
            }
        })
    });

    //当输入时错误提示消失
    $("form input").focus(function () {
        $(this).next().text("");
    });

    //每次关闭模态框时清空数据
    $("#close_model").click(function () {
        $("form input").val("").next("span").text("");
    })
</script>
</body>

</html>