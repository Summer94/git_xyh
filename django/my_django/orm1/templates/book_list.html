{% extends 'layout.html' %}
{% block book_css %}
    <style>
        th {
            text-align: center;
        }
    </style>
{% endblock %}
{% block content %}
    <h3>书籍信息页面</h3>
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#add_book">
        <span class="glyphicon glyphicon-plus"></span>添加书籍
    </button>
    <table class="table table-striped table-bordered table-hover text-center">
        <thead>
        <tr>
            <th>序号</th>
            <th>id</th>
            <th>书籍名称</th>
            <th>作者</th>
            <th>出版社名称</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        {% for book in book_list %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ book.id }}</td>
                <td>{{ book.title }}</td>
                <td>
                    {% for author in book.author_set.all %}
                        {% if forloop.last %}
                            {{ author.name }}
                        {% else %}
                            {{ author.name }}、
                        {% endif %}
                    {% empty %}
                        匿名
                    {% endfor %}
                </td>
                <td pb="{{ book.publisher.id }}">{{ book.publisher.name }}</td>
                <td>
                    <a href="{% url 'app01:del_book' %}?id={{ book.id }}">
                        <button type="button" class="btn btn-sm btn-danger" aria-label="Left Align">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
                        </button>
                    </a>
                    |
                    <a href="{% url 'app01:edit_book' %}?id={{ book.id }}">
                        <button type="button" class="btn btn-sm btn-success" aria-label="Left Align">
                            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑
                        </button>
                    </a>
                    <button type="button" class="btn btn-success mo-edit" data-toggle="modal" data-target="#add_book">
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>模态框编辑
                    </button>
                </td>

            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridSystemModalLabel" id="add_book">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="gridSystemModalLabel">添加书籍</h4>
                </div>
                <div class="modal-body">
                    <form action="{% url 'app01:add_book' %}" method="post" novalidate autocomplete="off">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="book_name">书籍名称</label>
                            <input type="text" class="form-control" id="book_name" name="name"
                                   placeholder="请输入书籍名称">
                        </div>
                        <div class="form-group">
                            <label for="publisher">出版社</label>
                            <select name="publisher" id="publisher" class="form-control">
                                {% for publisher in publisher_list %}
                                    <option value="{{ publisher.id }}">{{ publisher.name }}</option>
                                {% endfor %}

                            </select>
                        </div>
                        <button type="submit" class="btn btn-default" id="btn-add">添加</button>
                        <button type="submit" class="btn btn-default hide" id="btn-edit">完成</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}
{% block js %}
    <script>
        //模态框添加书籍信息
        $(".mo-edit").on("click", function () {
            //模态框添加时完成按钮出现，添加按钮隐藏
            $("#btn-edit").removeClass("hide").prev().addClass("hide");
            //找到被编辑的书籍内容并复制到标签中
            var b_name = $(this).parent().parent().children(":eq(2)").text();
            $("#book_name").val(b_name);
            //找到被编辑的书籍的相关出版社，并将option标签selected
            var publisher_id = $(this).parent().parent().children().eq(4).attr("pb");
            var op = $(".modal-body option");
            op.each(function (i, v) {
                if ($(v).val() === publisher_id) {
                    //$(v).attr("selected","selected");
                    $(v).prop("selected", true)
                }
            });
            //将form表单中的action修改成编辑模式，并将被编辑的书籍的id传入
            var b_id = $(this).parent().parent().children().eq(1).text();
            var i = "/app01/edit_book/?id=s".replace("s", b_id);
            var b = $(".modal-body form").attr("action", i);
        })
    </script>
{% endblock %}